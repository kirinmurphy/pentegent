services:
  scanner:
    build:
      context: ..
      dockerfile: scanner/Dockerfile
      target: builder
    command: npx tsx watch src/index.ts
    working_dir: /app/scanner
    volumes:
      - ../shared/src:/app/shared/src
      - ../scanner/src:/app/scanner/src
      - scanner-data:/data
    stop_grace_period: 5s
    environment:
      - SCANNER_PORT=8080
      - SCANNER_HOST=0.0.0.0
      - DB_PATH=/data/scanner.sqlite
      - REPORTS_DIR=/data/reports
      - CHOKIDAR_USEPOLLING=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      start_period: 30s
      retries: 3

  controller:
    build:
      context: ..
      dockerfile: controller/Dockerfile
      target: builder
    command: npx tsx watch src/index.ts
    working_dir: /app/controller
    volumes:
      - ../shared/src:/app/shared/src
      - ../controller/src:/app/controller/src
    environment:
      - CHOKIDAR_USEPOLLING=true
    stop_grace_period: 5s
